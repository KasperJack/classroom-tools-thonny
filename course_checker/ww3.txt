from thonny import get_workbench
from .checker import run_check_dialog
import os
import tkinter as tk

def load_plugin():
    print("DEBUG: Course Checker plugin is loading!")
    
    plugin_dir = os.path.dirname(__file__)
    icon_path = os.path.join(plugin_dir, "check.png")
    
    # Store exercise code in workbench for access across functions
    get_workbench().exercise_code = tk.StringVar()
    
    # Add commands for the three buttons
    get_workbench().add_command(
        command_id="pull_exercise",
        menu_name="run",
        command_label="Pull Exercise",
        handler=lambda: pull_exercise(get_workbench().exercise_code.get()),
        include_in_toolbar=True,
        caption="Pull Exercise",
        group=10
    )
    
    get_workbench().add_command(
        command_id="run_test",
        menu_name="run",
        command_label="Run Test",
        handler=lambda: run_test(get_workbench().exercise_code.get()),
        include_in_toolbar=True,
        caption="Run Test",
        group=10
    )
    
    get_workbench().add_command(
        command_id="pull_solution",
        menu_name="run",
        command_label="Pull Solution",
        handler=lambda: pull_solution(get_workbench().exercise_code.get()),
        include_in_toolbar=True,
        caption="Pull Solution",
        group=10
    )
    
    # Add text entry to toolbar
    def add_exercise_input():
        toolbar = get_workbench().get_toolbar()
        
        # Find all existing columns
        existing_columns = []
        for widget in toolbar.grid_slaves():
            try:
                info = widget.grid_info()
                if 'column' in info:
                    existing_columns.append(int(info['column']))
            except:
                pass
        
        # Start after the last existing column
        start_column = max(existing_columns, default=-1) + 1
        
        # Add a separator for visual grouping (optional)
        separator = tk.Frame(toolbar, width=2, bg="gray", height=20)
        separator.grid(row=0, column=start_column, padx=5, sticky="ns")
        
        # Add a label
        label = tk.Label(toolbar, text="Exercise Code:")
        label.grid(row=0, column=start_column + 1, padx=(5, 2), sticky="w")
        
        # Add entry widget
        entry = tk.Entry(toolbar, textvariable=get_workbench().exercise_code, width=15)
        entry.grid(row=0, column=start_column + 2, padx=2, sticky="w")
    
    # Schedule adding the entry after UI is ready (before buttons are added)
    get_workbench().after(50, add_exercise_input)


# Handler functions for the buttons
def pull_exercise(exercise_code):
    print(f"Pulling exercise: {exercise_code}")
    # Add your logic to pull exercise here
    if not exercise_code:
        print("ERROR: No exercise code provided")
        return
    # Your pull exercise implementation

def run_test(exercise_code):
    print(f"Running test for exercise: {exercise_code}")
    # Add your logic to run tests here
    if not exercise_code:
        print("ERROR: No exercise code provided")
        return
    # Your run test implementation

def pull_solution(exercise_code):
    print(f"Pulling solution for exercise: {exercise_code}")
    # Add your logic to pull solution here
    if not exercise_code:
        print("ERROR: No exercise code provided")
        return
